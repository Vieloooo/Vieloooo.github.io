<!DOCTYPE html>
<html><head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>xv6 file system - Vielog</title><meta name="viewport" content="width=device-width, initial-scale=1">

	<meta property="og:image" content=""/>
	<meta property="og:title" content="xv6 file system" />
<meta property="og:description" content="a quick overview of xv6 7 layer file system" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/xv6-fs/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-01T10:34:07+08:00" />
<meta property="article:modified_time" content="2021-10-01T10:34:07+08:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="xv6 file system"/>
<meta name="twitter:description" content="a quick overview of xv6 7 layer file system"/>
<script src="/js/feather.min.js"></script>
	
	<link href="/css/fonts.css" rel="stylesheet">
	
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
	
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="/">Vielog</a>
	</div>
	<nav>
		
		<a href="/posts">All posts</a>
		
		<a href="/authors/about">About</a>
		
		<a href="/tags">Tags</a>
		
		<a href="/gallery/moments">Gallery</a>
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">xv6 file system</h1>
			<div class="meta">Created on Oct 1, 2021</div>
		</div>
		

		<section class="body">
			<h1 id="xv6-file-system-overview">xv6 File system overview</h1>
<p>In general, There are 3 different ascpect on unix-like file system, file descriptor, file/directory and block.
In xv6, they are distributed into 7 layers:
<img src="/images/cs/xv6-layer.png" alt=""></p>
<hr>
<h2 id="block-interface">Block interface</h2>
<p>The xv file system&rsquo;s block interface consists of 34 layers(disk, buffer cache , logging and bitmap)
<strong>Goal: achieve crash recovery</strong></p>
<h3 id="disk">Disk</h3>
<p>Disk is the  most primitive layer of fs, which provide directly block R/W in device.
<img src="/images/cs/xv6-disk-ds.png" alt=""></p>
<h3 id="buffer-cache">Buffer cache</h3>
<p>This layer maintains a LRU Buffer queue to cache block data on disk, providing</p>
<ol>
<li>data structure</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> {

<span style="color:#66d9ef">struct</span> spinlock lock;
<span style="color:#66d9ef">struct</span> buf buf[NBUF];
<span style="color:#75715e">//maintain an LRU queue 
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> buf head;<span style="color:#75715e">// entry for the queue
</span><span style="color:#75715e"></span>} bcache;
<span style="color:#75715e">// head -&gt; free buffs -&gt; used buffs -&gt; head 
</span></code></pre></div><h3 id="logging">Logging</h3>
<p><strong>every modify on disk must be handled by logging layer to achieve crach tolerence</strong>
logging layer organizes all temporary modification on disk. any modification on block from upper layer</p>
<p><strong>Log methods:</strong>
!(images/cs/xv6-fs-log.png)</p>
<ol>
<li><code>commit()</code>, when no fs syscall occurs, logging layer commit() current logs ( modification stored on buffer), write they directly on disk.</li>
<li>when crash happened, fs can recovery data from logs block in disk, and write logs on data block.</li>
</ol>
<h3 id="bitmap">Bitmap</h3>
<p>bitmap is used to indicate which block is free or used on one device. It use 1 bit to represent 1 block on device.
provide lower level <code>balloc(), bfree()</code>.</p>
<hr>
<h2 id="inodedir-interface">Inode/Dir interface</h2>
<p>This layer combine inode block and data block to form a complete file, like <code>hello.c</code>,  or a directory.
In this interface, we operate fs on file level, ignoring the blocks operation.</p>
<h3 id="how-a-file-organized--inode-layer">How a file organized ? 	inode layer</h3>
<p><strong>Let&rsquo;s introduce inode</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> inode {
uint dev; <span style="color:#75715e">// Device number
</span><span style="color:#75715e"></span>uint inum; <span style="color:#75715e">// Inode number
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> ref; <span style="color:#75715e">// Reference count
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> sleeplock lock; <span style="color:#75715e">// protects everything below here
</span><span style="color:#75715e"></span><span style="color:#66d9ef">int</span> valid; <span style="color:#75715e">// inode has been read from diskon
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//-----------inode stored in disk----------- 
</span><span style="color:#75715e"></span><span style="color:#66d9ef">short</span> type; <span style="color:#75715e">// File type
</span><span style="color:#75715e"></span><span style="color:#66d9ef">short</span> major; <span style="color:#75715e">// Major device number (T_DEVICE only)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">short</span> minor; <span style="color:#75715e">// Minor device number (T_DEVICE only)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">short</span> nlink; <span style="color:#75715e">// Number of links to inode in file system
</span><span style="color:#75715e"></span>uint size; <span style="color:#75715e">// Size of file (bytes)
</span><span style="color:#75715e"></span>uint addrs[NDIRECT<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>]; <span style="color:#75715e">// Data block addresses
</span><span style="color:#75715e"></span>};

<span style="color:#75715e">// And inode layer has its own space to cache disk inode
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> {
<span style="color:#66d9ef">struct</span> spinlock lock;
<span style="color:#66d9ef">struct</span> inode inode[NINODE];
} icache;
</code></pre></div><p><strong>ref and nlink</strong>
2 of the most important fields are <code>ref</code> and <code>nlink</code>, the first one only cached in memory, means how many c pointer in memory pointing to it (fd, working dir), the second one means how many links point to this inode in   only in fs structure, like a directory points to a inode, another inode points to this inode, etc.</p>
<p>The <code>iupdate()</code>can write inode in cache to disk.</p>
<h3 id="directory-layer">Directory layer</h3>
<p>directory layer provides dir structure</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> dirent {
ushort inum;
<span style="color:#66d9ef">char</span> name[DIRSIZ];
};

</code></pre></div><p>If a file&rsquo;s type is dir, its data block is just a dirent structure.
In this layer, fs provides methods:
<code>dirlookup()</code>, if someone what to find something in a directory
<code>dirlink()</code>, insert a directory under another directory.</p>
<h3 id="path-names">Path names</h3>
<p>provide a useful layer where user can find inode by pathname
<code>namei() namex()</code></p>
<hr>
<h2 id="file-discriptor-interface">File discriptor interface</h2>
<p>In unix-like system, everything is represented as a file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> file {

<span style="color:#66d9ef">enum</span> { FD_NONE, FD_PIPE, FD_INODE, FD_DEVICE } type;
<span style="color:#66d9ef">int</span> ref; <span style="color:#75715e">// reference count
</span><span style="color:#75715e"></span><span style="color:#66d9ef">char</span> readable;
<span style="color:#66d9ef">char</span> writable;

<span style="color:#66d9ef">struct</span> pipe <span style="color:#f92672">*</span>pipe; <span style="color:#75715e">// FD_PIPE
</span><span style="color:#75715e"></span><span style="color:#66d9ef">struct</span> inode <span style="color:#f92672">*</span>ip; <span style="color:#75715e">// FD_INODE and FD_DEVICE
</span><span style="color:#75715e"></span>uint off; <span style="color:#75715e">// FD_INODE
</span><span style="color:#75715e"></span><span style="color:#66d9ef">short</span> major; <span style="color:#75715e">// FD_DEVICE
</span><span style="color:#75715e"></span>};
</code></pre></div><p>file is a wrapper around either an inode or a pipe, plus an i/o offset.
<strong>xv6 fs maintain all opening file by <code>ftable</code></strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c" data-lang="c"><span style="color:#66d9ef">struct</span> {

<span style="color:#66d9ef">struct</span> spinlock lock;
<span style="color:#66d9ef">struct</span> file file[NFILE];
} ftable;
</code></pre></div>
		</section>

		<div class="post-tags">
			
			
			<nav class="nav tags">
				<ul class="tags">
					
					<li><a href="/tags/xv6">xv6</a></li>
					
					<li><a href="/tags/operating-system">operating system</a></li>
					
				</ul>
			</nav>
			
			
		</div>
	</article>
</main>
<footer>
<hr><a class="soc" href="https://github.com/Vieloooo" title="GitHub"><i data-feather="github"></i></a>|<a class="soc" href="https://twitter.com/PlasticHug/" title="Twitter"><i data-feather="twitter"></i></a>|<a class="soc" href="mailto:mailto:jin.liu.0201@gmail.com" title="Email"><i data-feather="mail"></i></a>|<a class="soc" href="https://t.me/J6mple" title="Telegram"><i data-feather="navigation"></i></a>|不能 不明白| <a href="https://gohugo.io">Hugo</a> - <a href="https://github.com/athul/archie">archie</a>
</footer>


<script>
      feather.replace()
</script></div>
    </body>
</html>
