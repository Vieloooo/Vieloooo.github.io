<!DOCTYPE html>
<html><head>
	<meta charset="utf-8" />
	<meta http-equiv="X-UA-Compatible" content="IE=edge"><title>MIT xv6 design from user prespective - Vielog</title><meta name="viewport" content="width=device-width, initial-scale=1">

	<meta property="og:image" content=""/>
	<meta property="og:title" content="MIT xv6 design from user prespective" />
<meta property="og:description" content="this is description" />
<meta property="og:type" content="article" />
<meta property="og:url" content="/posts/xv6-lab1/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-10-01T10:34:07+08:00" />
<meta property="article:modified_time" content="2021-10-01T10:34:07+08:00" />
<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="MIT xv6 design from user prespective"/>
<meta name="twitter:description" content="this is description"/>
<script src="/js/feather.min.js"></script>
	
	<link href="/css/fonts.css" rel="stylesheet">
	
	<link rel="stylesheet" type="text/css" media="screen" href="/css/main.css" />
	
	<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">
	
</head>
<body>
        <div class="content"><header>
	<div class="main">
		<a href="/">Vielog</a>
	</div>
	<nav>
		
		<a href="/posts">All posts</a>
		
		<a href="/authors/about">About</a>
		
		<a href="/tags">Tags</a>
		
		<a href="/gallery/moments">Gallery</a>
		
	</nav>
</header>

<main>
	<article>
		<div class="title">
			<h1 class="title">MIT xv6 design from user prespective</h1>
			<div class="meta">Created on Oct 1, 2021</div>
		</div>
		

		<section class="body">
			<p>I will use mit 6.s801 lab1 &ldquo;util&rdquo; as an entry to the code behind.
This article will not talk much about how to do lab1, but  reveal some delicate design behind the syscall lab1 use.</p>
<h2 id="ex1--sleep">ex1- sleep</h2>
<p>#easy</p>
<p>This is the easiest lab in the lab1, so I will not talk about this exercise. Let&rsquo;s go through the syscall <code>sys_sleep</code> in <code>sysproc.c</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>uint64
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sys_sleep</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> n;
</span></span><span style="display:flex;"><span>  uint ticks0;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">argint</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>n) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acquire</span>(<span style="color:#f92672">&amp;</span>tickslock);
</span></span><span style="display:flex;"><span>  ticks0 <span style="color:#f92672">=</span> ticks;			<span style="color:#75715e">// ticks is a golbal var maintained by trap
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">while</span>(ticks <span style="color:#f92672">-</span> ticks0 <span style="color:#f92672">&lt;</span> n){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">myproc</span>()<span style="color:#f92672">-&gt;</span>killed){
</span></span><span style="display:flex;"><span>      <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>tickslock);
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">sleep</span>(<span style="color:#f92672">&amp;</span>ticks, <span style="color:#f92672">&amp;</span>tickslock);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>tickslock);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ol>
<li>
<p><code>ticks</code> is the global variable  maintained in <code>trap.c</code>, when a time interrupt occurs(1 ms) , the <code>devintr()</code> in <code>trap.c</code> will add up <code>ticks</code>. <code>ticks</code> is protected by <code>tickslock</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#a6e22e">clockintr</span>()
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">acquire</span>(<span style="color:#f92672">&amp;</span>tickslock);
</span></span><span style="display:flex;"><span>  ticks<span style="color:#f92672">++</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">wakeup</span>(<span style="color:#f92672">&amp;</span>ticks);
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>tickslock);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
<li>
<p><code>sleep()</code> in kernel, take 2 vars, the first one is the <strong>condition variable</strong>( aka <code>chan</code>variable ), which is saved in the proc&rsquo;s PCB, the next one is the lock that will be release before sleep.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">struct</span> proc {
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>chan;                  <span style="color:#75715e">// If non-zero, sleeping on chan
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  ...
</span></span><span style="display:flex;"><span>  ...
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div></li>
<li>
<p>everytime <code>ticks</code>++ in <code> clockintr()</code>, it will <code>wakeup()</code> all sleeping process holding <code>ticks</code> in its <code>chan</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">void</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">wakeup</span>(<span style="color:#66d9ef">void</span> <span style="color:#f92672">*</span>chan)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">for</span>(p <span style="color:#f92672">=</span> proc; p <span style="color:#f92672">&lt;</span> <span style="color:#f92672">&amp;</span>proc[NPROC]; p<span style="color:#f92672">++</span>) {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">acquire</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(p<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">==</span> SLEEPING <span style="color:#f92672">&amp;&amp;</span> p<span style="color:#f92672">-&gt;</span>chan <span style="color:#f92672">==</span> chan) {
</span></span><span style="display:flex;"><span>      p<span style="color:#f92672">-&gt;</span>state <span style="color:#f92672">=</span> RUNNABLE;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">release</span>(<span style="color:#f92672">&amp;</span>p<span style="color:#f92672">-&gt;</span>lock);
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div></li>
</ol>
<h2 id="ex2--pingpong">ex2- pingpong</h2>
<p>#easy</p>
<p>another easy lab, in this section I will dive in the syscall <code>sys_pipe()</code> <code>read()</code>, <code>write()</code>, and try to answer why the pipe need be in one direction while using.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span>uint64
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">sys_pipe</span>(<span style="color:#66d9ef">void</span>)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>  uint64 fdarray; <span style="color:#75715e">// user pointer to array of two integers
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">struct</span> file <span style="color:#f92672">*</span>rf, <span style="color:#f92672">*</span>wf;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">int</span> fd0, fd1;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">struct</span> proc <span style="color:#f92672">*</span>p <span style="color:#f92672">=</span> <span style="color:#a6e22e">myproc</span>();
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">argaddr</span>(<span style="color:#ae81ff">0</span>, <span style="color:#f92672">&amp;</span>fdarray) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">pipealloc</span>(<span style="color:#f92672">&amp;</span>rf, <span style="color:#f92672">&amp;</span>wf) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  fd0 <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>((fd0 <span style="color:#f92672">=</span> <span style="color:#a6e22e">fdalloc</span>(rf)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span> (fd1 <span style="color:#f92672">=</span> <span style="color:#a6e22e">fdalloc</span>(wf)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(fd0 <span style="color:#f92672">&gt;=</span> <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>      p<span style="color:#f92672">-&gt;</span>ofile[fd0] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fileclose</span>(rf);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fileclose</span>(wf);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">copyout</span>(p<span style="color:#f92672">-&gt;</span>pagetable, fdarray, (<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>fd0, <span style="color:#66d9ef">sizeof</span>(fd0)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">||</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">copyout</span>(p<span style="color:#f92672">-&gt;</span>pagetable, fdarray<span style="color:#f92672">+</span><span style="color:#66d9ef">sizeof</span>(fd0), (<span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>)<span style="color:#f92672">&amp;</span>fd1, <span style="color:#66d9ef">sizeof</span>(fd1)) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span>){
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">-&gt;</span>ofile[fd0] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    p<span style="color:#f92672">-&gt;</span>ofile[fd1] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fileclose</span>(rf);
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">fileclose</span>(wf);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ol>
<li>File system</li>
</ol>
<h2 id="ex45-find-and-xargs">ex4/5 find and xargs</h2>
<p>#mid
I will talk about the directory layer and inode layer of the xv6 File system</p>
<h2 id="ex3-primes">ex3 primes</h2>
<p>#hard
Dive in <code>fork()</code>, and the basic design of &ldquo;ex3 primes&rdquo;.</p>

		</section>

		<div class="post-tags">
			
			
			
		</div>
	</article>
</main>
<footer>
<hr><a class="soc" href="https://github.com/Vieloooo" title="GitHub"><i data-feather="github"></i></a>|<a class="soc" href="https://twitter.com/PlasticHug/" title="Twitter"><i data-feather="twitter"></i></a>|<a class="soc" href="mailto:mailto:jin.liu.0201@gmail.com" title="Email"><i data-feather="mail"></i></a>|<a class="soc" href="https://t.me/J6mple" title="Telegram"><i data-feather="navigation"></i></a>|不能 不明白| <a href="https://gohugo.io">Hugo</a> - <a href="https://github.com/athul/archie">archie</a>
</footer>


<script>
      feather.replace()
</script></div>
    </body>
</html>
